name: Publish

permissions:
  contents: write

on:
  workflow_dispatch:
  workflow_run:
    workflows:
    - Release
    types:
    - completed

jobs:
  publish:
    if: ${{github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'}}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup GitHub Actions Bot
      uses: vanyauhalin/action-gh-bot@v0

    - name: Setup mise
      uses: jdx/mise-action@v2

    - name: Install Dependencies
      run: pnpm install --frozen-lockfile

    - name: Build Documentation
      run: pnpm build-docs

    - name: Publish Documentation
      working-directory: docs
      run: |
        un=$(git config --get user.name)
        ru="${{github.server_url}}/${{github.repository}}.git"
        ru=$(echo "$ru" | sed "s#https://#https://$un:${{github.token}}@#")

        td=$(mktemp -d)
        git clone --quiet --no-checkout --single-branch --branch gh-pages "$ru" "$td"

        mv "$td/.git" .
        git add .

        if git diff-index --quiet HEAD --; then
          echo "No changes to commit"
        else
          git commit --quiet --message "$(date --utc)"
          git push
        fi
